<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>将棋 AI</title>
    <style>
        :root {
            --board-color: #e3c878;
            --board-shadow: #bfa35a;
            --piece-bg: #fdf5e6;<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>将棋 AI</title>
    <style>
        :root {
            --board-color: #e3c878;
            --board-shadow: #bfa35a;
            --piece-bg: #fdf5e6;
            --piece-text: #1a1a1a;
            --promoted-text: #d32f2f;
        }

        body {
            font-family: "Sawarabi Mincho", serif;
            background-color: #2b1d1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .screen { display: none; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        /* レイアウト構成：縦に並べる */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* 持ち駒エリア */
        .hand-box {
            background: #d7ccc8;
            color: #3e2723;
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 560px;
            min-height: 60px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        .hand-label { font-size: 0.8rem; font-weight: bold; opacity: 0.7; width: 80px; }
        .hand-pieces { display: flex; flex-wrap: wrap; gap: 8px; flex-grow: 1; }

        /* 盤面 */
        #board-container {
            background: var(--board-shadow);
            padding: 10px;
            border-radius: 2px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        #board {
            display: grid;
            grid-template-columns: repeat(9, 62px);
            grid-template-rows: repeat(9, 64px);
            gap: 1px;
            background: #222;
        }
        .sq {
            width: 62px; height: 64px;
            background-color: var(--board-color);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }

        /* 駒のデザイン：文字サイズを大きく調整 */
        .piece {
            background: var(--piece-bg);
            color: var(--piece-text);
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 5px; /* 先端の余白 */
            font-weight: bold;
            box-sizing: border-box;
            clip-path: polygon(50% 0%, 92% 18%, 100% 100%, 0% 100%, 8% 18%);
            box-shadow: inset 0 -3px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            z-index: 2;
        }

        /* サイズと文字の黄金比を再計算 */
        .p-K { width: 57px; height: 61px; font-size: 38px; } 
        .p-R, .p-B { width: 53px; height: 57px; font-size: 34px; }
        .p-G, .p-S { width: 50px; height: 54px; font-size: 32px; }
        .p-N, .p-L { width: 46px; height: 50px; font-size: 28px; }
        .p-P { width: 42px; height: 46px; font-size: 26px; }

        .piece.ai { transform: rotate(180deg); }
        .piece.promoted { color: var(--promoted-text); }

        .hand-piece {
            background: var(--piece-bg);
            clip-path: polygon(50% 0%, 92% 18%, 100% 100%, 0% 100%, 8% 18%);
            display: flex; justify-content: center; align-items: center;
            color: var(--piece-text);
            width: 40px; height: 44px; font-size: 22px;
            position: relative; cursor: pointer;
        }
        .hand-piece.selected { background: #fff176; outline: 2px solid #f44336; }

        /* 設定画面 */
        .menu-card {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            width: 320px;
        }
        .option-group { margin-bottom: 20px; text-align: left; }
        select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; }

        #status { font-size: 1.4rem; margin-bottom: 10px; color: #e3c878; }
        .controls { margin-top: 15px; display: flex; gap: 10px; }
        button { padding: 10px 20px; background: #5d4037; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .badge { position: absolute; bottom: -2px; right: -2px; background: #d32f2f; color: white; font-size: 10px; padding: 1px 4px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <div class="menu-card">
            <h1 style="letter-spacing: 5px;">将棋 AI</h1>
            <div class="option-group">
                <label>難易度</label>
                <select id="ai-level">
                    <option value="1">初級</option>
                    <option value="2">中級</option>
                    <option value="3" selected>名人</option>
                </select>
            </div>
            <div class="option-group">
                <label>先手選択</label>
                <select id="first-move">
                    <option value="player">あなた</option>
                    <option value="ai">AI</option>
                    <option value="random">ランダム</option>
                </select>
            </div>
            <button onclick="startGame()" style="width: 100%;">対局開始</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="status">対局中...</div>
        
        <div class="game-container">
            <div class="hand-box">
                <div class="hand-label">AI 持ち駒</div>
                <div id="hand-ai" class="hand-pieces"></div>
            </div>

            <div id="board-container">
                <div id="board"></div>
            </div>

            <div class="hand-box">
                <div class="hand-label">自軍 持ち駒</div>
                <div id="hand-player" class="hand-pieces"></div>
            </div>
        </div>

        <div class="controls">
            <button onclick="exportCSV()">棋譜保存</button>
            <button onclick="location.reload()" style="background:#3e2723;">タイトルへ</button>
        </div>
    </div>

    <script>
        const PIECES = {
            'K': '王', 'R': '飛', 'B': '角', 'G': '金', 'S': '銀', 'N': '桂', 'L': '香', 'P': '歩',
            'R+': '龍', 'B+': '馬', 'S+': '全', 'N+': '圭', 'L+': '杏', 'P+': 'と'
        };
        const SCORE = { 'K': 10000, 'R': 1000, 'B': 800, 'G': 600, 'S': 500, 'N': 400, 'L': 300, 'P': 100, 'R+': 1300, 'B+': 1100, 'S+': 650, 'N+': 650, 'L+': 650, 'P+': 650 };

        let board = [], handPlayer = [], handAI = [], history = [];
        let selected = null, isTurnPlayer = true, isGameOver = false, aiLevel = 3, lastMove = null;

        function startGame() {
            aiLevel = parseInt(document.getElementById('ai-level').value);
            const firstMovePref = document.getElementById('first-move').value;
            
            if (firstMovePref === 'player') isTurnPlayer = true;
            else if (firstMovePref === 'ai') isTurnPlayer = false;
            else isTurnPlayer = Math.random() < 0.5;

            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            initGame();
        }

        function initGame() {
            board = [
                ['l','n','s','g','k','g','s','n','l'],
                [' ','r',' ',' ',' ',' ',' ','b',' '],
                ['p','p','p','p','p','p','p','p','p'],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                ['P','P','P','P','P','P','P','P','P'],
                [' ','B',' ',' ',' ',' ',' ','R',' '],
                ['L','N','S','G','K','G','S','N','L']
            ];
            updateStatus();
            render();
            if (!isTurnPlayer) setTimeout(aiRoutine, 600);
        }

        function updateStatus() {
            const statusEl = document.getElementById('status');
            if (isGameOver) return;
            statusEl.textContent = isTurnPlayer ? "あなたの番です" : "AI 思考中...";
        }

        function render() {
            const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const sq = document.createElement('div'); sq.className = 'sq';
                    if (selected && selected.type === 'board' && selected.r === r && selected.c === c) sq.classList.add('selected');
                    if (lastMove && lastMove.tr === r && lastMove.tc === c) sq.classList.add('last-move');
                    
                    const p = board[r][c];
                    if (p !== ' ') {
                        const pEl = document.createElement('div');
                        const baseType = p.toUpperCase().replace('+', '');
                        pEl.className = `piece p-${baseType}` + (p === p.toLowerCase() ? ' ai' : '') + (p.includes('+') ? ' promoted' : '');
                        pEl.textContent = PIECES[p.toUpperCase()] || PIECES[p];
                        sq.appendChild(pEl);
                    }
                    sq.onclick = () => onSquareClick(r, c);
                    boardEl.appendChild(sq);
                }
            }
            renderHand('hand-player', handPlayer, true);
            renderHand('hand-ai', handAI, false);
        }

        function renderHand(id, hand, isPlayer) {
            const container = document.getElementById(id); container.innerHTML = '';
            const counts = {}; hand.forEach(p => counts[p] = (counts[p] || 0) + 1);
            Object.keys(counts).forEach(p => {
                const div = document.createElement('div');
                div.className = 'hand-piece' + (isPlayer && selected && selected.piece === p ? ' selected' : '');
                div.textContent = PIECES[p];
                if (counts[p] > 1) {
                    const b = document.createElement('div'); b.className = 'badge'; b.textContent = counts[p];
                    div.appendChild(b);
                }
                if (isPlayer) div.onclick = (e) => { e.stopPropagation(); selectHand(p); };
                container.appendChild(div);
            });
        }

        function selectHand(piece) {
            if (!isTurnPlayer || isGameOver) return;
            selected = (selected && selected.piece === piece) ? null : { type: 'hand', piece };
            render();
        }

        function onSquareClick(r, c) {
            if (!isTurnPlayer || isGameOver) return;
            if (selected) {
                if (selected.type === 'board') {
                    if (isValidMoveLegal(selected.r, selected.c, r, c, board)) movePiece(selected.r, selected.c, r, c);
                } else if (selected.type === 'hand') {
                    if (canDrop(selected.piece, r, c, true, board)) dropPiece(selected.piece, r, c, true);
                }
                selected = null;
            } else if (board[r][c] !== ' ' && board[r][c] === board[r][c].toUpperCase()) {
                selected = { type: 'board', r, c };
            }
            render();
        }

        function movePiece(fr, fc, tr, tc) {
            let p = board[fr][fc];
            const target = board[tr][tc];
            if (target !== ' ') {
                const captured = target.replace('+', '').toUpperCase();
                (p === p.toUpperCase()) ? handPlayer.push(captured) : handAI.push(captured);
            }
            if (!p.includes('+') && "PSNLBR".includes(p.toUpperCase())) {
                if (p === p.toUpperCase() ? (tr <= 2 || fr <= 2) : (tr >= 6 || fr >= 6)) {
                    if (p === p.toUpperCase() ? confirm("成りますか？") : true) p += "+";
                }
            }
            board[tr][tc] = p; board[fr][fc] = ' ';
            lastMove = { tr, tc }; endTurn();
        }

        function dropPiece(piece, tr, tc, isPlayer) {
            board[tr][tc] = isPlayer ? piece.toUpperCase() : piece.toLowerCase();
            const hand = isPlayer ? handPlayer : handAI;
            hand.splice(hand.indexOf(piece.toUpperCase()), 1);
            lastMove = { tr, tc }; endTurn();
        }

        function endTurn() {
            isTurnPlayer = !isTurnPlayer;
            updateStatus();
            render();
            if (checkEndGame()) return;
            if (!isTurnPlayer) setTimeout(aiRoutine, 600);
        }

        function aiRoutine() {
            let moves = getLegalMoves(board, false);
            if (moves.length === 0) { alert("AIが投了しました。"); isGameOver = true; return; }
            let best = (aiLevel === 3) ? minimax(board, 2, -Infinity, Infinity, false).move : moves[Math.floor(Math.random()*moves.length)];
            if (best.type === 'move') movePiece(best.fr, best.fc, best.tr, best.tc);
            else dropPiece(best.piece, best.tr, best.tc, false);
        }

        // --- ロジック・エンジン部分は以前と同一 ---
        function minimax(b, depth, alpha, beta, isMax) {
            if (depth === 0) return { score: evaluate(b) };
            let moves = getLegalMoves(b, isMax);
            if (moves.length === 0) return { score: isMax ? -100000 : 100000 };
            let bestM = null;
            if (isMax) {
                let val = -Infinity;
                for (let m of moves) {
                    let s = minimax(simMove(b, m), depth - 1, alpha, beta, false).score;
                    if (s > val) { val = s; bestM = m; }
                    alpha = Math.max(alpha, val); if (beta <= alpha) break;
                }
                return { score: val, move: bestM };
            } else {
                let val = Infinity;
                for (let m of moves) {
                    let s = minimax(simMove(b, m), depth - 1, alpha, beta, true).score;
                    if (s < val) { val = s; bestM = m; }
                    beta = Math.min(beta, s); if (beta <= alpha) break;
                }
                return { score: val, move: bestM };
            }
        }
        function evaluate(b) {
            let s = 0;
            for(let r=0; r<9; r++) for(let c=0; c<9; c++){
                const p = b[r][c]; if(p===' ') continue;
                let v = SCORE[p.toUpperCase()] + ((p === p.toUpperCase()) ? (8-r)*5 : r*5);
                s += (p === p.toUpperCase()) ? v : -v;
            }
            return s;
        }
        function getLegalMoves(b, isP) {
            let moves = [];
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                if(b[r][c] !== ' ' && (b[r][c] === b[r][c].toUpperCase()) === isP) {
                    for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(isValidMoveLegal(r, c, tr, tc, b)) moves.push({type:'move', fr:r, fc:c, tr, tc});
                }
            }
            let hand = isP ? handPlayer : handAI;
            [...new Set(hand)].forEach(p => {
                for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(canDrop(p, tr, tc, isP, b)) moves.push({type:'drop', piece:p, tr, tc});
            });
            return moves;
        }
        function isValidMoveLegal(fr, fc, tr, tc, b) {
            if (!isValidMoveBasic(fr, fc, tr, tc, b)) return false;
            let temp = simMove(b, {type:'move', fr, fc, tr, tc});
            return !isCheck(b[fr][fc] === b[fr][fc].toLowerCase(), temp);
        }
        function isCheck(isAI, b) {
            let kPos = null; const k = isAI ? 'k' : 'K';
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(b[r][c]===k) kPos={r,c};
            if(!kPos) return true;
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                const p = b[r][c]; if(p !== ' ' && (p===p.toLowerCase()) !== isAI) if(isValidMoveBasic(r, c, kPos.r, kPos.c, b)) return true;
            }
            return false;
        }
        function isValidMoveBasic(fr, fc, tr, tc, b) {
            const p = b[fr][fc], tp = b[tr][tc];
            if (tp !== ' ' && (p === p.toUpperCase()) === (tp === tp.toUpperCase())) return false;
            const dr = tr-fr, dc = tc-fc, adr = Math.abs(dr), adc = Math.abs(dc), s = p === p.toUpperCase() ? -1 : 1;
            if (p.includes('+')) {
                const base = p.replace('+', '').toUpperCase();
                if (base === 'R') return (dr === 0 || dc === 0 || (adr === 1 && adc === 1)) && isClear(fr, fc, tr, tc, b);
                if (base === 'B') return (adr === adc || (adr === 1 && dc === 0) || (adc === 1 && dr === 0)) && isClear(fr, fc, tr, tc, b);
                return (adr <= 1 && adc <= 1) && !(dr === -s && adc === 1);
            }
            switch(p.toUpperCase()) {
                case 'P': return dc === 0 && dr === s;
                case 'L': return dc === 0 && dr*s > 0 && isClear(fr, fc, tr, tc, b);
                case 'N': return dr === s*2 && adc === 1;
                case 'S': return (adr === 1 && adc === 1) || (dr === s && dc === 0);
                case 'G': return (adr <= 1 && adc <= 1) && !(dr === -s && adc === 1);
                case 'K': return adr <= 1 && adc <= 1;
                case 'B': return adr === adc && isClear(fr, fc, tr, tc, b);
                case 'R': return (dr === 0 || dc === 0) && isClear(fr, fc, tr, tc, b);
            }
            return false;
        }
        function isClear(fr, fc, tr, tc, b) {
            const sr = Math.sign(tr-fr), sc = Math.sign(tc-fc);
            let r = fr+sr, c = fc+sc;
            while(r!==tr || c!==tc){ if(b[r][c]!==' ') return false; r+=sr; c+=sc; }
            return true;
        }
        function canDrop(p, tr, tc, isP, b) {
            if (b[tr][tc] !== ' ') return false;
            if ((p==='P'||p==='L') && (isP ? tr===0 : tr===8)) return false;
            if (p==='N' && (isP ? tr<=1 : tr>=7)) return false;
            if (p==='P') for(let r=0; r<9; r++) if(b[r][tc]===(isP?'P':'p')) return false;
            return true;
        }
        function simMove(b, m) {
            let n = b.map(r => [...r]);
            if(m.type==='move'){ n[m.tr][m.tc]=n[m.fr][m.fc]; n[m.fr][m.fc]=' '; }
            else{ n[m.tr][m.tc] = m.isPlayer ? m.piece.toUpperCase() : m.piece.toLowerCase(); }
            return n;
        }
        function checkEndGame() {
            if(getLegalMoves(board, isTurnPlayer).length === 0) {
                const winner = isTurnPlayer ? "AI" : "あなた";
                document.getElementById('status').textContent = winner + "の勝利！";
                isGameOver = true; return true;
            }
            return false;
        }
        function exportCSV() { alert("棋譜を保存しました（シミュレーション）"); }
    </script>
</body>
</html>
            --piece-text: #1a1a1a;
            --promoted-text: #d32f2f;
        }

        body {
            font-family: "Sawarabi Mincho", serif;
            background-color: #2b1d1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .screen { display: none; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }

        /* レイアウト構成：縦に並べる */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* 持ち駒エリア */
        .hand-box {
            background: #d7ccc8;
            color: #3e2723;
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 560px;
            min-height: 60px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        .hand-label { font-size: 0.8rem; font-weight: bold; opacity: 0.7; width: 80px; }
        .hand-pieces { display: flex; flex-wrap: wrap; gap: 8px; flex-grow: 1; }

        /* 盤面 */
        #board-container {
            background: var(--board-shadow);
            padding: 10px;
            border-radius: 2px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        #board {
            display: grid;
            grid-template-columns: repeat(9, 62px);
            grid-template-rows: repeat(9, 64px);
            gap: 1px;
            background: #222;
        }
        .sq {
            width: 62px; height: 64px;
            background-color: var(--board-color);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }

        /* 駒のデザイン：文字サイズを大きく調整 */
        .piece {
            background: var(--piece-bg);
            color: var(--piece-text);
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 5px; /* 先端の余白 */
            font-weight: bold;
            box-sizing: border-box;
            clip-path: polygon(50% 0%, 92% 18%, 100% 100%, 0% 100%, 8% 18%);
            box-shadow: inset 0 -3px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            z-index: 2;
        }

        /* サイズと文字の黄金比を再計算 */
        .p-K { width: 57px; height: 61px; font-size: 38px; } 
        .p-R, .p-B { width: 53px; height: 57px; font-size: 34px; }
        .p-G, .p-S { width: 50px; height: 54px; font-size: 32px; }
        .p-N, .p-L { width: 46px; height: 50px; font-size: 28px; }
        .p-P { width: 42px; height: 46px; font-size: 26px; }

        .piece.ai { transform: rotate(180deg); }
        .piece.promoted { color: var(--promoted-text); }

        .hand-piece {
            background: var(--piece-bg);
            clip-path: polygon(50% 0%, 92% 18%, 100% 100%, 0% 100%, 8% 18%);
            display: flex; justify-content: center; align-items: center;
            color: var(--piece-text);
            width: 40px; height: 44px; font-size: 22px;
            position: relative; cursor: pointer;
        }
        .hand-piece.selected { background: #fff176; outline: 2px solid #f44336; }

        /* 設定画面 */
        .menu-card {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            width: 320px;
        }
        .option-group { margin-bottom: 20px; text-align: left; }
        select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; }

        #status { font-size: 1.4rem; margin-bottom: 10px; color: #e3c878; }
        .controls { margin-top: 15px; display: flex; gap: 10px; }
        button { padding: 10px 20px; background: #5d4037; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .badge { position: absolute; bottom: -2px; right: -2px; background: #d32f2f; color: white; font-size: 10px; padding: 1px 4px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <div class="menu-card">
            <h1 style="letter-spacing: 5px;">将棋 AI</h1>
            <div class="option-group">
                <label>難易度</label>
                <select id="ai-level">
                    <option value="1">初級</option>
                    <option value="2">中級</option>
                    <option value="3" selected>名人</option>
                </select>
            </div>
            <div class="option-group">
                <label>先手選択</label>
                <select id="first-move">
                    <option value="player">あなた</option>
                    <option value="ai">AI</option>
                    <option value="random">ランダム</option>
                </select>
            </div>
            <button onclick="startGame()" style="width: 100%;">対局開始</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="status">対局中...</div>
        
        <div class="game-container">
            <div class="hand-box">
                <div class="hand-label">AI 持ち駒</div>
                <div id="hand-ai" class="hand-pieces"></div>
            </div>

            <div id="board-container">
                <div id="board"></div>
            </div>

            <div class="hand-box">
                <div class="hand-label">自軍 持ち駒</div>
                <div id="hand-player" class="hand-pieces"></div>
            </div>
        </div>

        <div class="controls">
            <button onclick="exportCSV()">棋譜保存</button>
            <button onclick="location.reload()" style="background:#3e2723;">タイトルへ</button>
        </div>
    </div>

    <script>
        const PIECES = {
            'K': '王', 'R': '飛', 'B': '角', 'G': '金', 'S': '銀', 'N': '桂', 'L': '香', 'P': '歩',
            'R+': '龍', 'B+': '馬', 'S+': '全', 'N+': '圭', 'L+': '杏', 'P+': 'と'
        };
        const SCORE = { 'K': 10000, 'R': 1000, 'B': 800, 'G': 600, 'S': 500, 'N': 400, 'L': 300, 'P': 100, 'R+': 1300, 'B+': 1100, 'S+': 650, 'N+': 650, 'L+': 650, 'P+': 650 };

        let board = [], handPlayer = [], handAI = [], history = [];
        let selected = null, isTurnPlayer = true, isGameOver = false, aiLevel = 3, lastMove = null;

        function startGame() {
            aiLevel = parseInt(document.getElementById('ai-level').value);
            const firstMovePref = document.getElementById('first-move').value;
            
            if (firstMovePref === 'player') isTurnPlayer = true;
            else if (firstMovePref === 'ai') isTurnPlayer = false;
            else isTurnPlayer = Math.random() < 0.5;

            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            initGame();
        }

        function initGame() {
            board = [
                ['l','n','s','g','k','g','s','n','l'],
                [' ','r',' ',' ',' ',' ',' ','b',' '],
                ['p','p','p','p','p','p','p','p','p'],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                [' ',' ',' ',' ',' ',' ',' ',' ',' '],
                ['P','P','P','P','P','P','P','P','P'],
                [' ','B',' ',' ',' ',' ',' ','R',' '],
                ['L','N','S','G','K','G','S','N','L']
            ];
            updateStatus();
            render();
            if (!isTurnPlayer) setTimeout(aiRoutine, 600);
        }

        function updateStatus() {
            const statusEl = document.getElementById('status');
            if (isGameOver) return;
            statusEl.textContent = isTurnPlayer ? "あなたの番です" : "AI 思考中...";
        }

        function render() {
            const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const sq = document.createElement('div'); sq.className = 'sq';
                    if (selected && selected.type === 'board' && selected.r === r && selected.c === c) sq.classList.add('selected');
                    if (lastMove && lastMove.tr === r && lastMove.tc === c) sq.classList.add('last-move');
                    
                    const p = board[r][c];
                    if (p !== ' ') {
                        const pEl = document.createElement('div');
                        const baseType = p.toUpperCase().replace('+', '');
                        pEl.className = `piece p-${baseType}` + (p === p.toLowerCase() ? ' ai' : '') + (p.includes('+') ? ' promoted' : '');
                        pEl.textContent = PIECES[p.toUpperCase()] || PIECES[p];
                        sq.appendChild(pEl);
                    }
                    sq.onclick = () => onSquareClick(r, c);
                    boardEl.appendChild(sq);
                }
            }
            renderHand('hand-player', handPlayer, true);
            renderHand('hand-ai', handAI, false);
        }

        function renderHand(id, hand, isPlayer) {
            const container = document.getElementById(id); container.innerHTML = '';
            const counts = {}; hand.forEach(p => counts[p] = (counts[p] || 0) + 1);
            Object.keys(counts).forEach(p => {
                const div = document.createElement('div');
                div.className = 'hand-piece' + (isPlayer && selected && selected.piece === p ? ' selected' : '');
                div.textContent = PIECES[p];
                if (counts[p] > 1) {
                    const b = document.createElement('div'); b.className = 'badge'; b.textContent = counts[p];
                    div.appendChild(b);
                }
                if (isPlayer) div.onclick = (e) => { e.stopPropagation(); selectHand(p); };
                container.appendChild(div);
            });
        }

        function selectHand(piece) {
            if (!isTurnPlayer || isGameOver) return;
            selected = (selected && selected.piece === piece) ? null : { type: 'hand', piece };
            render();
        }

        function onSquareClick(r, c) {
            if (!isTurnPlayer || isGameOver) return;
            if (selected) {
                if (selected.type === 'board') {
                    if (isValidMoveLegal(selected.r, selected.c, r, c, board)) movePiece(selected.r, selected.c, r, c);
                } else if (selected.type === 'hand') {
                    if (canDrop(selected.piece, r, c, true, board)) dropPiece(selected.piece, r, c, true);
                }
                selected = null;
            } else if (board[r][c] !== ' ' && board[r][c] === board[r][c].toUpperCase()) {
                selected = { type: 'board', r, c };
            }
            render();
        }

        function movePiece(fr, fc, tr, tc) {
            let p = board[fr][fc];
            const target = board[tr][tc];
            if (target !== ' ') {
                const captured = target.replace('+', '').toUpperCase();
                (p === p.toUpperCase()) ? handPlayer.push(captured) : handAI.push(captured);
            }
            if (!p.includes('+') && "PSNLBR".includes(p.toUpperCase())) {
                if (p === p.toUpperCase() ? (tr <= 2 || fr <= 2) : (tr >= 6 || fr >= 6)) {
                    if (p === p.toUpperCase() ? confirm("成りますか？") : true) p += "+";
                }
            }
            board[tr][tc] = p; board[fr][fc] = ' ';
            lastMove = { tr, tc }; endTurn();
        }

        function dropPiece(piece, tr, tc, isPlayer) {
            board[tr][tc] = isPlayer ? piece.toUpperCase() : piece.toLowerCase();
            const hand = isPlayer ? handPlayer : handAI;
            hand.splice(hand.indexOf(piece.toUpperCase()), 1);
            lastMove = { tr, tc }; endTurn();
        }

        function endTurn() {
            isTurnPlayer = !isTurnPlayer;
            updateStatus();
            render();
            if (checkEndGame()) return;
            if (!isTurnPlayer) setTimeout(aiRoutine, 600);
        }

        function aiRoutine() {
            let moves = getLegalMoves(board, false);
            if (moves.length === 0) { alert("AIが投了しました。"); isGameOver = true; return; }
            let best = (aiLevel === 3) ? minimax(board, 2, -Infinity, Infinity, false).move : moves[Math.floor(Math.random()*moves.length)];
            if (best.type === 'move') movePiece(best.fr, best.fc, best.tr, best.tc);
            else dropPiece(best.piece, best.tr, best.tc, false);
        }

        // --- ロジック・エンジン部分は以前と同一 ---
        function minimax(b, depth, alpha, beta, isMax) {
            if (depth === 0) return { score: evaluate(b) };
            let moves = getLegalMoves(b, isMax);
            if (moves.length === 0) return { score: isMax ? -100000 : 100000 };
            let bestM = null;
            if (isMax) {
                let val = -Infinity;
                for (let m of moves) {
                    let s = minimax(simMove(b, m), depth - 1, alpha, beta, false).score;
                    if (s > val) { val = s; bestM = m; }
                    alpha = Math.max(alpha, val); if (beta <= alpha) break;
                }
                return { score: val, move: bestM };
            } else {
                let val = Infinity;
                for (let m of moves) {
                    let s = minimax(simMove(b, m), depth - 1, alpha, beta, true).score;
                    if (s < val) { val = s; bestM = m; }
                    beta = Math.min(beta, s); if (beta <= alpha) break;
                }
                return { score: val, move: bestM };
            }
        }
        function evaluate(b) {
            let s = 0;
            for(let r=0; r<9; r++) for(let c=0; c<9; c++){
                const p = b[r][c]; if(p===' ') continue;
                let v = SCORE[p.toUpperCase()] + ((p === p.toUpperCase()) ? (8-r)*5 : r*5);
                s += (p === p.toUpperCase()) ? v : -v;
            }
            return s;
        }
        function getLegalMoves(b, isP) {
            let moves = [];
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                if(b[r][c] !== ' ' && (b[r][c] === b[r][c].toUpperCase()) === isP) {
                    for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(isValidMoveLegal(r, c, tr, tc, b)) moves.push({type:'move', fr:r, fc:c, tr, tc});
                }
            }
            let hand = isP ? handPlayer : handAI;
            [...new Set(hand)].forEach(p => {
                for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(canDrop(p, tr, tc, isP, b)) moves.push({type:'drop', piece:p, tr, tc});
            });
            return moves;
        }
        function isValidMoveLegal(fr, fc, tr, tc, b) {
            if (!isValidMoveBasic(fr, fc, tr, tc, b)) return false;
            let temp = simMove(b, {type:'move', fr, fc, tr, tc});
            return !isCheck(b[fr][fc] === b[fr][fc].toLowerCase(), temp);
        }
        function isCheck(isAI, b) {
            let kPos = null; const k = isAI ? 'k' : 'K';
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(b[r][c]===k) kPos={r,c};
            if(!kPos) return true;
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                const p = b[r][c]; if(p !== ' ' && (p===p.toLowerCase()) !== isAI) if(isValidMoveBasic(r, c, kPos.r, kPos.c, b)) return true;
            }
            return false;
        }
        function isValidMoveBasic(fr, fc, tr, tc, b) {
            const p = b[fr][fc], tp = b[tr][tc];
            if (tp !== ' ' && (p === p.toUpperCase()) === (tp === tp.toUpperCase())) return false;
            const dr = tr-fr, dc = tc-fc, adr = Math.abs(dr), adc = Math.abs(dc), s = p === p.toUpperCase() ? -1 : 1;
            if (p.includes('+')) {
                const base = p.replace('+', '').toUpperCase();
                if (base === 'R') return (dr === 0 || dc === 0 || (adr === 1 && adc === 1)) && isClear(fr, fc, tr, tc, b);
                if (base === 'B') return (adr === adc || (adr === 1 && dc === 0) || (adc === 1 && dr === 0)) && isClear(fr, fc, tr, tc, b);
                return (adr <= 1 && adc <= 1) && !(dr === -s && adc === 1);
            }
            switch(p.toUpperCase()) {
                case 'P': return dc === 0 && dr === s;
                case 'L': return dc === 0 && dr*s > 0 && isClear(fr, fc, tr, tc, b);
                case 'N': return dr === s*2 && adc === 1;
                case 'S': return (adr === 1 && adc === 1) || (dr === s && dc === 0);
                case 'G': return (adr <= 1 && adc <= 1) && !(dr === -s && adc === 1);
                case 'K': return adr <= 1 && adc <= 1;
                case 'B': return adr === adc && isClear(fr, fc, tr, tc, b);
                case 'R': return (dr === 0 || dc === 0) && isClear(fr, fc, tr, tc, b);
            }
            return false;
        }
        function isClear(fr, fc, tr, tc, b) {
            const sr = Math.sign(tr-fr), sc = Math.sign(tc-fc);
            let r = fr+sr, c = fc+sc;
            while(r!==tr || c!==tc){ if(b[r][c]!==' ') return false; r+=sr; c+=sc; }
            return true;
        }
        function canDrop(p, tr, tc, isP, b) {
            if (b[tr][tc] !== ' ') return false;
            if ((p==='P'||p==='L') && (isP ? tr===0 : tr===8)) return false;
            if (p==='N' && (isP ? tr<=1 : tr>=7)) return false;
            if (p==='P') for(let r=0; r<9; r++) if(b[r][tc]===(isP?'P':'p')) return false;
            return true;
        }
        function simMove(b, m) {
            let n = b.map(r => [...r]);
            if(m.type==='move'){ n[m.tr][m.tc]=n[m.fr][m.fc]; n[m.fr][m.fc]=' '; }
            else{ n[m.tr][m.tc] = m.isPlayer ? m.piece.toUpperCase() : m.piece.toLowerCase(); }
            return n;
        }
        function checkEndGame() {
            if(getLegalMoves(board, isTurnPlayer).length === 0) {
                const winner = isTurnPlayer ? "AI" : "あなた";
                document.getElementById('status').textContent = winner + "の勝利！";
                isGameOver = true; return true;
            }
            return false;
        }
        function exportCSV() { alert("棋譜を保存しました（シミュレーション）"); }
    </script>
</body>
</html>
